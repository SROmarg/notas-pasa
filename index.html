<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bk:#0a0f0a;--dk:#111811;--dk2:#162016;--dk3:#1c281c;
  --br:#233023;--br2:#2e3e2e;
  --g:#4ade80;--g2:#86efac;--gd:rgba(74,222,128,0.10);--gd2:rgba(74,222,128,0.04);
  --w:#f0f7f0;--tx:#c8dfc8;--tx2:#8aab8a;--mu:#4a634a;--mu2:#2e3e2e;
  --rd:#f87171;--y:#fbbf24;
  --fn:'IBM Plex Sans',sans-serif;--fc:'IBM Plex Mono',monospace;
  --radius:4px;--radius-lg:8px;
  --shadow:0 4px 24px rgba(0,0,0,0.5);
  --transition:0.15s ease;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bk);color:var(--tx);font-family:var(--fn);min-height:100vh;font-size:13px;overscroll-behavior-y:none;-webkit-font-smoothing:antialiased;}
button,select,input,textarea{font-family:var(--fn);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--br2);border-radius:2px;}

/* HEADER */
header{background:var(--dk);border-bottom:1px solid var(--br2);padding:0 20px;height:52px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:300;box-shadow:0 1px 0 var(--g),0 2px 20px rgba(0,0,0,0.5);}
.lb{background:var(--g);color:var(--bk);font-family:var(--fc);font-weight:700;font-size:9px;padding:4px 8px;border-radius:3px;letter-spacing:1px;}
.ln{font-family:var(--fc);font-size:13px;font-weight:700;color:var(--w);letter-spacing:-0.3px;}
.ln span{color:var(--g);}
.hd{width:1px;height:18px;background:var(--br2);}
.ht{font-family:var(--fc);font-size:9px;font-weight:600;color:var(--mu);letter-spacing:2px;text-transform:uppercase;}
.hr{margin-left:auto;display:flex;align-items:center;gap:8px;}
.sp{background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.3);color:var(--g);font-size:10px;padding:2px 8px;border-radius:20px;display:flex;align-items:center;gap:4px;opacity:0;transition:opacity 0.4s;}
.sp.show{opacity:1;}
.hbtn{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:4px 8px;font-size:13px;cursor:pointer;line-height:1;transition:all var(--transition);}
.hbtn:hover{border-color:var(--g);color:var(--g);}

/* LAYOUT */
.layout{display:grid;grid-template-columns:380px 1fr;min-height:calc(100vh - 52px);}
.fs{background:var(--dk);border-right:1px solid var(--br);overflow-y:auto;max-height:calc(100vh - 52px);scrollbar-width:thin;scrollbar-color:var(--br2) transparent;}
.fi{padding:18px 16px 32px;}

/* HERO DESKTOP */
.scan-hero{background:linear-gradient(160deg,var(--dk2) 0%,rgba(74,222,128,0.04) 100%);border:1px solid rgba(74,222,128,0.15);border-radius:var(--radius-lg);padding:22px 18px;margin-bottom:14px;text-align:center;}
.scan-hero-icon{font-size:36px;margin-bottom:10px;display:block;}
.scan-hero-title{font-family:var(--fc);font-size:15px;font-weight:700;color:var(--w);margin-bottom:5px;}
.scan-hero-sub{font-size:11px;color:var(--tx2);line-height:1.6;margin-bottom:16px;}
.scan-hero-btn{width:100%;background:var(--g);color:var(--bk);border:none;border-radius:var(--radius);padding:13px;font-family:var(--fc);font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;justify-content:center;gap:8px;}
.scan-hero-btn:hover{background:var(--g2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(74,222,128,0.2);}
.scan-hero-btn:active{transform:translateY(0);}
.scan-hero-pills{display:flex;justify-content:center;gap:6px;margin-top:10px;flex-wrap:wrap;}
.scan-pill{background:var(--dk);border:1px solid var(--br2);border-radius:20px;padding:3px 9px;font-size:9px;color:var(--mu);font-family:var(--fc);}

/* SESSION BAR */
.session-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--dk2);border:1px solid var(--br);border-radius:var(--radius);margin-bottom:12px;font-size:11px;color:var(--mu);}
.session-bar strong{color:var(--g);font-family:var(--fc);font-size:14px;}
.session-bar .sep{flex:1;}
.s-excel{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:4px 10px;font-size:10px;font-family:var(--fc);font-weight:600;cursor:pointer;transition:all var(--transition);}
.s-excel:hover{border-color:var(--g);color:var(--g);}
.s-excel:disabled{opacity:0.3;cursor:default;}

/* FORM TOGGLE */
.form-toggle{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:var(--dk2);border:1px solid var(--br);border-radius:var(--radius);cursor:pointer;transition:all var(--transition);}
.form-toggle:hover{border-color:var(--br2);}
.form-toggle-label{font-family:var(--fc);font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--mu);}
.form-toggle-icon{font-size:11px;color:var(--mu);transition:transform 0.2s;}
.form-toggle.open .form-toggle-icon{transform:rotate(180deg);}
.form-collapse{overflow:hidden;max-height:0;transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1);}
.form-collapse.open{max-height:2000px;}
.form-collapse-inner{padding-top:14px;}

/* FORM */
.sec{display:flex;align-items:center;gap:8px;margin:18px 0 10px;}
.sec:first-child{margin-top:0;}
.sn{background:var(--g);color:var(--bk);font-family:var(--fc);font-weight:700;font-size:8px;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sl{font-family:var(--fc);font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--g);}
.sl2{flex:1;height:1px;background:var(--br);}
.fg{display:grid;gap:7px;margin-bottom:7px;}
.fg.c2{grid-template-columns:1fr 1fr;}
.fg.c3{grid-template-columns:1fr 1fr 1fr;}
.fg.c1{grid-template-columns:1fr;}
label{display:block;font-size:8px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--mu);margin-bottom:3px;font-family:var(--fc);}
input[type=text],input[type=number],input[type=date],input[type=time],select,textarea{
  width:100%;background:var(--dk2);border:1px solid var(--br2);border-radius:var(--radius);
  padding:8px 10px;color:var(--tx);font-family:var(--fn);font-size:12px;outline:none;
  transition:border-color var(--transition),background var(--transition),box-shadow var(--transition);
  -webkit-appearance:none;appearance:none;}
input:hover,select:hover,textarea:hover{background:var(--dk3);}
input:focus,select:focus,textarea:focus{border-color:var(--g);background:var(--dk3);box-shadow:0 0 0 3px rgba(74,222,128,0.07);}
select option{background:var(--dk2);}
textarea{resize:vertical;min-height:48px;}
.bgen{width:100%;margin-top:14px;padding:12px;background:var(--g);color:var(--bk);border:none;border-radius:var(--radius);font-family:var(--fc);font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all var(--transition);}
.bgen:hover{background:var(--g2);transform:translateY(-1px);}
.bgen:active{transform:translateY(0);}

/* TABLE */
.ts{display:flex;flex-direction:column;overflow:hidden;}
.th2{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--br);flex-shrink:0;background:var(--dk);}
.ttl{font-family:var(--fc);font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--tx2);display:flex;align-items:center;gap:8px;}
.cb{background:var(--gd);border:1px solid rgba(74,222,128,0.3);color:var(--g);font-size:10px;font-weight:600;padding:1px 8px;border-radius:20px;font-family:var(--fc);}
.tacts{display:flex;gap:6px;}
.bxl{background:var(--g);color:var(--bk);border:none;border-radius:var(--radius);padding:6px 13px;font-family:var(--fc);font-size:10px;font-weight:700;text-transform:uppercase;cursor:pointer;letter-spacing:0.5px;transition:all var(--transition);}
.bxl:hover{background:var(--g2);transform:translateY(-1px);}
.bxl:disabled{opacity:0.3;cursor:default;}
.bclr{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:6px 10px;font-size:10px;cursor:pointer;transition:all var(--transition);}
.bclr:hover{border-color:var(--rd);color:var(--rd);}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:40px 20px;}
.ei{width:60px;height:60px;border:2px dashed var(--br2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;opacity:0.4;}
.empty p{font-size:11px;text-align:center;line-height:1.9;color:var(--mu);}
.empty strong{color:var(--g);}
.tw{overflow:auto;flex:1;}
table{width:100%;border-collapse:collapse;font-size:11px;}
thead th{background:var(--dk2);color:var(--tx2);font-family:var(--fc);font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:8px 10px;text-align:left;border-bottom:1px solid var(--br);white-space:nowrap;position:sticky;top:0;z-index:10;border-right:1px solid var(--br);}
thead th:last-child{border-right:none;}
tbody tr{border-bottom:1px solid var(--br);transition:background 0.1s;}
tbody tr:hover{background:var(--gd2);}
tbody tr.nr{animation:ri 0.5s ease;}
@keyframes ri{from{background:rgba(74,222,128,0.08);}to{background:transparent;}}
tbody td{padding:7px 10px;vertical-align:top;color:var(--tx);white-space:nowrap;border-right:1px solid var(--br);font-size:11px;}
tbody td:last-child{border-right:none;}
td.num{color:var(--mu2);font-size:9px;text-align:center;font-family:var(--fc);}
td.wc{white-space:normal;max-width:140px;font-size:10px;line-height:1.5;}
td.kg{font-family:var(--fc);font-weight:600;color:var(--g);}
.chip{display:inline-flex;background:var(--gd);border:1px solid rgba(74,222,128,0.2);color:var(--g);font-family:var(--fc);font-weight:600;font-size:9px;padding:2px 7px;border-radius:20px;}
.ra{display:flex;gap:3px;}
.bcp,.bdl{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:3px 8px;font-size:10px;cursor:pointer;transition:all 0.15s;}
.bcp:hover{border-color:var(--g);color:var(--g);}
.bdl:hover{border-color:var(--rd);color:var(--rd);}
.bcp.ok{border-color:var(--g);color:var(--g);}

/* OVERLAYS */
.ov{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:500;display:flex;align-items:center;justify-content:center;padding:14px;overflow-y:auto;}
@media(max-width:700px){.ov.rev-ov{align-items:flex-end;padding:0;overflow-y:hidden;}}

/* SCAN MODAL */
.mo{background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--g);border-radius:var(--radius-lg);padding:20px;max-width:460px;width:100%;max-height:88vh;overflow-y:auto;}
.mot{font-family:var(--fc);font-size:12px;font-weight:700;color:var(--g);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;}
.mo p{font-size:11px;color:var(--mu);line-height:1.7;margin-bottom:10px;}
.ib{background:rgba(74,222,128,0.05);border:1px solid rgba(74,222,128,0.15);border-radius:var(--radius);padding:10px 12px;margin-bottom:12px;font-size:11px;color:var(--tx2);line-height:1.7;}
.ib strong{color:var(--g);}
.dz{border:2px dashed var(--br2);border-radius:var(--radius-lg);padding:22px 16px;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:10px;}
.dz:hover,.dz.over{border-color:var(--g);background:var(--gd);}
.dzi{font-size:32px;margin-bottom:8px;display:block;}
.dz p{font-size:11px;color:var(--mu);line-height:1.6;}
.dz strong{color:var(--g);font-family:var(--fc);}
.dz-cam-row{display:none;gap:8px;margin-bottom:10px;}
.dz-cam-btn,.dz-file-btn{flex:1;padding:11px;border-radius:var(--radius);font-family:var(--fc);font-size:12px;font-weight:700;cursor:pointer;transition:all var(--transition);}
.dz-cam-btn{background:var(--g);color:var(--bk);border:none;}
.dz-file-btn{background:none;border:1px solid var(--br2);color:var(--tx2);}
.dz-cam-btn:active,.dz-file-btn:active{transform:scale(0.97);}
@media(max-width:700px){.dz-cam-row{display:flex;}.dz{display:none;}}
.bq{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;max-height:200px;overflow-y:auto;}
.bi{background:var(--dk2);border:1px solid var(--br);border-radius:var(--radius);padding:8px 10px;display:flex;align-items:center;gap:9px;transition:border-color 0.2s;}
.bi.processing{border-color:var(--g);background:rgba(74,222,128,0.03);}
.bi.done{border-color:var(--g);opacity:0.7;}
.bi.error{border-color:var(--rd);}
.bith{width:40px;height:40px;object-fit:cover;border-radius:3px;flex-shrink:0;border:1px solid var(--br);}
.bii{flex:1;min-width:0;}
.bin{font-family:var(--fc);font-size:10px;font-weight:600;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bis{font-size:10px;margin-top:2px;}
.bis.pending{color:var(--mu);}
.bis.processing{color:var(--g);}
.bis.done{color:var(--g);}
.bis.error{color:var(--rd);}
.birm{background:none;border:none;color:var(--mu2);font-size:12px;cursor:pointer;flex-shrink:0;}
.birm:hover{color:var(--rd);}
.prog-wrap{margin-bottom:12px;display:none;}
.prog-wrap.show{display:block;}
.prog-label{font-size:10px;color:var(--mu);margin-bottom:5px;display:flex;justify-content:space-between;font-family:var(--fc);}
.prog-label strong{color:var(--g);}
.prog-bar{height:3px;background:var(--br);border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;background:var(--g);border-radius:2px;transition:width 0.4s ease;width:0%;}
.mbtns{display:flex;gap:8px;}
.bstart{flex:1;background:var(--g);color:var(--bk);border:none;border-radius:var(--radius);padding:11px;font-family:var(--fc);font-size:12px;font-weight:700;text-transform:uppercase;cursor:pointer;letter-spacing:0.5px;transition:all var(--transition);}
.bstart:hover{background:var(--g2);}
.bstart:disabled{opacity:0.4;cursor:default;}
.bcanc{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:11px 14px;font-size:11px;cursor:pointer;transition:all var(--transition);}
.bcanc:hover{border-color:var(--rd);color:var(--rd);}

/* REVIEW MODAL */
.rmo{background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--g);border-radius:var(--radius-lg);padding:20px;max-width:600px;width:100%;overflow-y:auto;max-height:90vh;scrollbar-width:thin;}
.rmt{font-family:var(--fc);font-size:10px;font-weight:700;color:var(--g);letter-spacing:2px;text-transform:uppercase;margin-bottom:3px;display:flex;align-items:center;gap:6px;}
.rmc{font-size:10px;color:var(--mu);margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--br);font-family:var(--fc);}
.rlay{display:grid;grid-template-columns:140px 1fr;gap:14px;margin-bottom:12px;}
.rimg{width:100%;border-radius:var(--radius);border:1px solid var(--br2);object-fit:contain;background:var(--dk2);max-height:200px;cursor:zoom-in;}
.rst{font-family:var(--fc);font-size:8px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--g);margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--br2);display:flex;align-items:center;gap:5px;}
.rst::before{content:'';display:block;width:3px;height:3px;border-radius:50%;background:var(--g);}
.rs{margin-bottom:12px;}
.rg{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}
.rg.c1{grid-template-columns:1fr;}
.rg.c3{grid-template-columns:1fr 1fr 1fr;}
.rf label{display:block;font-size:8px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--mu);margin-bottom:3px;font-family:var(--fc);}
.rf input,.rf select{width:100%;background:var(--dk2);border:1px solid var(--br2);border-radius:var(--radius);padding:6px 8px;color:var(--tx);font-family:var(--fn);font-size:11px;outline:none;transition:border-color var(--transition),box-shadow var(--transition);}
.rf input:focus,.rf select:focus{border-color:var(--g);box-shadow:0 0 0 2px rgba(74,222,128,0.08);}
.rf input.sc,.rf select.sc{border-color:rgba(74,222,128,0.5);background:rgba(74,222,128,0.04);}
.rbtns{display:flex;gap:8px;margin-top:12px;padding-bottom:env(safe-area-inset-bottom,0px);}
@media(max-width:700px){.rbtns{position:sticky;bottom:0;background:var(--dk);padding:10px 0 calc(10px + env(safe-area-inset-bottom,16px));margin-top:8px;}}
.bsave{flex:1;background:var(--g);color:var(--bk);border:none;border-radius:var(--radius);padding:12px;font-family:var(--fc);font-size:12px;font-weight:700;text-transform:uppercase;cursor:pointer;transition:all var(--transition);letter-spacing:0.5px;}
.bsave:hover{background:var(--g2);transform:translateY(-1px);}
.bsave:active{transform:translateY(0);}
.bskip{background:var(--dk2);border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:12px 16px;font-size:11px;cursor:pointer;font-family:var(--fc);font-weight:600;transition:all var(--transition);white-space:nowrap;}
.bskip:hover{color:var(--tx2);background:var(--dk3);}

/* TOAST */
.toast{position:fixed;top:64px;right:16px;background:var(--dk);border-radius:var(--radius);padding:10px 14px;font-size:12px;font-weight:600;font-family:var(--fc);transform:translateY(-10px);opacity:0;transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);z-index:9999;box-shadow:var(--shadow);max-width:280px;}
.toast.ok{border:1px solid var(--g);color:var(--g);}
.toast.warn{border:1px solid var(--y);color:var(--y);}
.toast.err{border:1px solid var(--rd);color:var(--rd);}
.toast.show{transform:translateY(0);opacity:1;}
@media(max-width:700px){.toast{right:14px;left:14px;max-width:unset;text-align:center;}}

/* API KEY MODAL */
.akmo{background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--g);border-radius:var(--radius-lg);padding:26px;max-width:400px;width:100%;}
.akmo h2{font-family:var(--fc);font-size:14px;font-weight:700;color:var(--g);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;}
.akmo p{font-size:11px;color:var(--mu);line-height:1.7;margin-bottom:12px;}
.akmo .hint{background:var(--gd);border:1px solid rgba(74,222,128,0.2);border-radius:var(--radius);padding:8px 11px;font-size:10px;color:var(--g);line-height:1.7;margin-bottom:12px;font-family:var(--fc);}
.akmo input{width:100%;background:var(--dk2);border:1px solid var(--br2);border-radius:var(--radius);padding:10px 12px;color:var(--tx);font-family:var(--fc);font-size:12px;outline:none;margin-bottom:12px;transition:border-color var(--transition);}
.akmo input:focus{border-color:var(--g);}
.akmo .err{font-size:10px;color:var(--rd);margin-bottom:8px;display:none;font-family:var(--fc);}
.bconf{width:100%;background:var(--g);color:var(--bk);border:none;border-radius:var(--radius);padding:10px;font-family:var(--fc);font-size:12px;font-weight:700;text-transform:uppercase;cursor:pointer;letter-spacing:0.5px;}
.bconf:hover{background:var(--g2);}
.bconf:disabled{opacity:0.4;cursor:default;}

/* CONFIRM DIALOG */
.conf-ov{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:600;display:flex;align-items:center;justify-content:center;padding:20px;}
.conf-box{background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--rd);border-radius:var(--radius-lg);padding:22px;max-width:300px;width:100%;}
.conf-title{font-family:var(--fc);font-size:12px;font-weight:700;color:var(--tx);margin-bottom:6px;}
.conf-msg{font-size:11px;color:var(--mu);margin-bottom:16px;line-height:1.6;}
.conf-btns{display:flex;gap:8px;}
.conf-cancel{flex:1;background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:9px;font-family:var(--fc);font-size:11px;font-weight:600;cursor:pointer;}
.conf-ok{flex:1;background:var(--rd);color:white;border:none;border-radius:var(--radius);padding:9px;font-family:var(--fc);font-size:11px;font-weight:700;cursor:pointer;}
.conf-ok:hover{background:#dc2626;}

/* HERO MÃ“VIL */
.hero-mobile{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 52px);padding:40px 24px;text-align:center;background:var(--bk);}
.hero-cam-btn{width:148px;height:148px;border-radius:50%;background:var(--g);border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;box-shadow:0 0 0 16px rgba(74,222,128,0.07),0 0 0 32px rgba(74,222,128,0.03);transition:all 0.2s;margin-bottom:24px;position:relative;}
.hero-cam-btn::after{content:'';position:absolute;inset:-16px;border-radius:50%;border:1px solid rgba(74,222,128,0.15);animation:pulse 2.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(1.06);opacity:0.4;}}
.hero-cam-btn:active{transform:scale(0.94);}
.hero-cam-btn .cam-icon{font-size:52px;line-height:1;}
.hero-cam-btn .cam-label{font-family:var(--fc);font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--bk);}
.hero-sub{font-size:13px;color:var(--mu);line-height:1.7;margin-bottom:22px;}
.hero-sub strong{color:var(--tx);}
.hero-stats{display:flex;gap:20px;margin-top:20px;margin-bottom:24px;}
.hero-stat{text-align:center;}
.hero-stat strong{display:block;font-family:var(--fc);font-size:22px;font-weight:700;color:var(--g);}
.hero-stat span{font-size:9px;color:var(--mu);letter-spacing:1px;text-transform:uppercase;font-family:var(--fc);}
.hero-actions{display:flex;flex-direction:column;gap:10px;width:100%;max-width:280px;}
.hero-excel-btn{width:100%;background:var(--g);color:var(--bk);border:none;border-radius:var(--radius);padding:14px;font-family:var(--fc);font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all var(--transition);}
.hero-excel-btn:disabled{opacity:0.3;cursor:default;}
.hero-excel-btn:not(:disabled):active{transform:scale(0.97);}
.hero-manual-btn{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:10px 20px;font-size:12px;font-family:var(--fc);font-weight:600;cursor:pointer;transition:all var(--transition);}
.hero-manual-btn:active{background:var(--dk2);}

/* MOBILE */
@media(max-width:700px){
  .layout{display:none;}
  .hero-mobile{display:flex;}
  .mo{max-width:100%;width:100%;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;max-height:92vh;margin:0;}
  .rmo{max-width:100%;width:100%;border-radius:16px 16px 0 0;max-height:92vh;}
  .rlay{grid-template-columns:1fr;}
  .rimg{max-height:110px;object-fit:cover;}
  .rg,.rg.c3{grid-template-columns:1fr;}
}
@media(min-width:701px){#mobileBar{display:none;}}
</style>
</head>
<body>

<!-- CONFIRM DIALOG -->
<div class="conf-ov" id="confOv" style="display:none">
  <div class="conf-box">
    <div class="conf-title" id="confTitle">Â¿Confirmar?</div>
    <div class="conf-msg" id="confMsg"></div>
    <div class="conf-btns">
      <button class="conf-cancel" onclick="confResolve(false)">Cancelar</button>
      <button class="conf-ok" id="confOkBtn" onclick="confResolve(true)">Eliminar</button>
    </div>
  </div>
</div>

<!-- API KEY MODAL -->
<div class="ov" id="akOv" style="display:none">
  <div class="akmo">
    <h2>ðŸ”‘ API Key</h2>
    <p>Necesitas una API Key de Anthropic para usar el escÃ¡ner de boletas.</p>
    <div class="hint">
      1. Ve a console.anthropic.com<br>
      2. API Keys â†’ Create Key<br>
      3. Pega la key aquÃ­ abajo
    </div>
    <input type="password" id="akInput" placeholder="sk-ant-api03-..." oninput="document.getElementById('bconf').disabled=!this.value.startsWith('sk-ant')">
    <div class="err" id="akErr">La key debe comenzar con sk-ant</div>
    <button class="bconf" id="bconf" onclick="saveKey()" disabled>Guardar y continuar</button>
  </div>
</div>

<!-- SCAN MODAL -->
<div class="ov" id="scanOv" style="display:none">
  <div class="mo">
    <div class="mot">ðŸ“„ Escanear boleta de bÃ¡scula</div>
    <p>Sube la foto de la boleta. Claude extrae todos los datos automÃ¡ticamente.</p>
    <div class="ib"><strong>Tip:</strong> AsegÃºrate de que la boleta estÃ© bien iluminada y legible, incluyendo el nombre del cliente escrito a mano.</div>
    <div class="dz" id="dz" onclick="document.getElementById('fbi').click()">
      <div class="dzi">ðŸ§¾</div>
      <p><strong>Clic para seleccionar</strong><br>o arrastra la imagen aquÃ­</p>
    </div>
    <input type="file" id="fbi" accept="image/*" capture="environment" multiple onchange="onFiles(event)">
    <div class="dz-cam-row">
      <button class="dz-cam-btn" onclick="document.getElementById('fbi').click()">ðŸ“· CÃ¡mara</button>
      <button class="dz-file-btn" onclick="triggerFileOnly()">ðŸ—‚ Archivo</button>
    </div>
    <div class="bq" id="bq" style="display:none"></div>
    <div class="prog-wrap" id="progWrap">
      <div class="prog-label"><span id="progText">Analizando...</span><strong id="progPct">0%</strong></div>
      <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
    </div>
    <div class="mbtns">
      <button class="bstart" id="bstart" onclick="runBatch()" disabled>âš¡ Analizar</button>
      <button class="bcanc" onclick="closeScan()">Cancelar</button>
    </div>
  </div>
</div>

<!-- REVIEW MODAL -->
<div class="ov rev-ov" id="revOv" style="display:none">
  <div class="rmo">
    <div class="rmt">âœ“ Revisar datos extraÃ­dos</div>
    <div class="rmc" id="rmc">Boleta 1 de 1 â€” verifica y corrige si es necesario</div>
    <div class="rlay">
      <img class="rimg" id="rimg" src="" alt="Boleta">
      <div>
        <div class="rs">
          <div class="rst">Encabezado</div>
          <div class="rg c3">
            <div class="rf"><label>Folio</label><input id="r_folio" class="sc"></div>
            <div class="rf"><label>Fecha</label><input id="r_fecha"></div>
            <div class="rf"><label>#ECO</label><input id="r_eco"></div>
          </div>
          <div class="rg">
            <div class="rf"><label>Hora Entrada</label><input id="r_hora_entrada"></div>
            <div class="rf"><label>Hora Salida</label><input id="r_hora_salida"></div>
          </div>
          <div class="rg">
            <div class="rf"><label>Cliente (manuscrito)</label><input id="r_cliente" class="sc"></div>
            <div class="rf"><label>Ruta</label><input id="r_ruta"></div>
          </div>
        </div>
        <div class="rs">
          <div class="rst">ClasificaciÃ³n</div>
          <div class="rg">
            <div class="rf"><label>Tipo Unidad</label><input id="r_tipo_unidad"></div>
            <div class="rf"><label>Tipo Residuos</label><input id="r_tipo_residuos"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="rs">
      <div class="rst">Pesaje</div>
      <div class="rg c3">
        <div class="rf"><label>Peso Bruto (kg)</label><input id="r_bruto" type="number"></div>
        <div class="rf"><label>Tara (kg)</label><input id="r_tara" type="number"></div>
        <div class="rf"><label>Neto (kg)</label><input id="r_neto" type="number"></div>
      </div>
      <div class="rg c1">
        <div class="rf"><label>Volumen MÂ³</label><input id="r_volumen"></div>
      </div>
    </div>
    <div class="rs">
      <div class="rst">Personal</div>
      <div class="rg">
        <div class="rf"><label>Operador</label><input id="r_operador"></div>
        <div class="rf"><label>Precio (manuscrito)</label><input id="r_precio" class="sc"></div>
      </div>
    </div>
    <div class="rbtns">
      <button class="bsave" onclick="saveRev()">âœ“ Guardar registro</button>
      <button class="bskip" onclick="skipRev()">Omitir</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="lb">GEN</div>
  <div class="ln">PASA <span>Reciclaje</span></div>
  <div class="hd"></div>
  <div class="ht">Notas Â· BÃ¡scula</div>
  <div class="hr">
    <div class="sp" id="sp">âœ“ Guardado</div>
    <button class="hbtn" onclick="document.getElementById('akOv').style.display='flex'" title="Configurar API Key">âš™</button>
  </div>
</header>

<!-- HERO MÃ“VIL -->
<div class="hero-mobile" id="heroMobile">
  <button class="hero-cam-btn" onclick="openScan()">
    <span class="cam-icon">ðŸ“·</span>
    <span class="cam-label">Escanear</span>
  </button>
  <p class="hero-sub">Toma una foto de la boleta de bÃ¡scula.<br><strong>Claude extrae los datos automÃ¡ticamente.</strong></p>
  <div class="hero-stats">
    <div class="hero-stat"><strong id="heroCount">0</strong><span>Registros</span></div>
    <div style="width:1px;height:32px;background:var(--br);align-self:center;"></div>
    <div class="hero-stat"><strong id="heroScans">0</strong><span>Boletas</span></div>
  </div>
  <div class="hero-actions">
    <button class="hero-excel-btn" id="heroExcel" onclick="shareExcel()" disabled>â†— Enviar por WhatsApp</button>
    <button class="hero-manual-btn" onclick="document.getElementById('manualMobOv').style.display='flex'">âœŽ Captura manual</button>
  </div>
</div>

<!-- FORMULARIO MANUAL MÃ“VIL -->
<div class="ov" id="manualMobOv" style="display:none;align-items:flex-end;padding:0;">
  <div style="background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--g);border-radius:16px 16px 0 0;width:100%;max-height:92vh;overflow-y:auto;padding:20px;">
    <div style="font-family:var(--fc);font-size:12px;font-weight:700;color:var(--g);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;">
      âœŽ Captura manual
      <button onclick="document.getElementById('manualMobOv').style.display='none'" style="background:none;border:none;color:var(--mu);font-size:18px;cursor:pointer;line-height:1;">âœ•</button>
    </div>
    <div class="sec" style="margin-top:0;"><div class="sn">1</div><div class="sl">Encabezado</div><div class="sl2"></div></div>
    <div class="fg c1"><div><label>Folio</label><input type="text" id="m_folio" placeholder="R82742"></div></div>
    <div class="fg c1"><div><label>Fecha</label><input type="text" id="m_fecha" placeholder="25/02/2026"></div></div>
    <div class="fg c1"><div><label>#ECO</label><input type="text" id="m_eco"></div></div>
    <div class="fg c1"><div><label>Hora Entrada</label><input type="text" id="m_hora_entrada" placeholder="09:02"></div></div>
    <div class="fg c1"><div><label>Hora Salida</label><input type="text" id="m_hora_salida" placeholder="09:35"></div></div>
    <div class="fg c1"><div><label>Cliente (manuscrito)</label><input type="text" id="m_cliente" placeholder="Fud Trailer"></div></div>
    <div class="fg c1"><div><label>Ruta</label><input type="text" id="m_ruta"></div></div>
    <div class="sec"><div class="sn">2</div><div class="sl">ClasificaciÃ³n</div><div class="sl2"></div></div>
    <div class="fg c1"><div><label>Tipo Unidad</label><input type="text" id="m_tipo_unidad" placeholder="REMOLQUE"></div></div>
    <div class="fg c1"><div><label>Tipo Residuos</label><input type="text" id="m_tipo_residuos"></div></div>
    <div class="sec"><div class="sn">3</div><div class="sl">Pesaje</div><div class="sl2"></div></div>
    <div class="fg c1"><div><label>Bruto (kg)</label><input type="number" id="m_bruto"></div></div>
    <div class="fg c1"><div><label>Tara (kg)</label><input type="number" id="m_tara"></div></div>
    <div class="fg c1"><div><label>Neto (kg)</label><input type="number" id="m_neto"></div></div>
    <div class="fg c1"><div><label>Volumen MÂ³</label><input type="text" id="m_volumen"></div></div>
    <div class="sec"><div class="sn">4</div><div class="sl">Personal</div><div class="sl2"></div></div>
    <div class="fg c1"><div><label>Operador</label><input type="text" id="m_operador"></div></div>
    <div class="fg c1"><div><label>Precio (manuscrito)</label><input type="number" id="m_precio" placeholder="1400.07"></div></div>
    <button class="bgen" onclick="addEntryMobile()" style="margin-bottom:20px;">âš¡ Guardar registro</button>
  </div>
</div>

<div class="layout">
  <!-- FORM -->
  <div class="fs">
    <div class="fi">
      <div class="scan-hero">
        <span class="scan-hero-icon">ðŸ§¾</span>
        <div class="scan-hero-title">Escanear boleta de bÃ¡scula</div>
        <div class="scan-hero-sub">Toma una foto de la boleta GEN PASA.<br>Claude extrae todos los campos automÃ¡ticamente.</div>
        <button class="scan-hero-btn" onclick="openScan()">
          <span>âš¡</span> Cargar foto de boleta
        </button>
        <div class="scan-hero-pills">
          <span class="scan-pill">âœ“ Folio y fecha</span>
          <span class="scan-pill">âœ“ Pesos bruto/tara/neto</span>
          <span class="scan-pill">âœ“ Cliente manuscrito</span>
          <span class="scan-pill">âœ“ Export Excel</span>
        </div>
      </div>

      <div class="session-bar">
        <span>Registros:</span>
        <strong id="rc2">0</strong>
        <span class="sep"></span>
        <button class="s-excel" id="bex2" onclick="exportExcel()" disabled>â†“ Excel</button>
      </div>

      <div class="form-toggle" id="formToggle" onclick="toggleForm()">
        <span class="form-toggle-label">âœŽ Captura manual</span>
        <span class="form-toggle-icon">â–¼</span>
      </div>
      <div class="form-collapse" id="formCollapse">
        <div class="form-collapse-inner">
          <div class="sec" style="margin-top:0;"><div class="sn">1</div><div class="sl">Encabezado</div><div class="sl2"></div></div>
          <div class="fg c3">
            <div><label>Folio</label><input type="text" id="folio" placeholder="R82742"></div>
            <div><label>Fecha</label><input type="text" id="fecha" placeholder="25/02/2026"></div>
            <div><label>#ECO</label><input type="text" id="eco"></div>
          </div>
          <div class="fg c2">
            <div><label>Hora Entrada</label><input type="text" id="hora_entrada" placeholder="09:02"></div>
            <div><label>Hora Salida</label><input type="text" id="hora_salida" placeholder="09:35"></div>
          </div>
          <div class="fg c2">
            <div><label>Cliente (manuscrito)</label><input type="text" id="cliente" placeholder="Fud Trailer"></div>
            <div><label>Ruta</label><input type="text" id="ruta"></div>
          </div>
          <div class="sec"><div class="sn">2</div><div class="sl">ClasificaciÃ³n</div><div class="sl2"></div></div>
          <div class="fg c2">
            <div><label>Tipo Unidad</label><input type="text" id="tipo_unidad" placeholder="REMOLQUE"></div>
            <div><label>Tipo Residuos</label><input type="text" id="tipo_residuos"></div>
          </div>
          <div class="sec"><div class="sn">3</div><div class="sl">Pesaje</div><div class="sl2"></div></div>
          <div class="fg c3">
            <div><label>Bruto (kg)</label><input type="number" id="bruto"></div>
            <div><label>Tara (kg)</label><input type="number" id="tara"></div>
            <div><label>Neto (kg)</label><input type="number" id="neto"></div>
          </div>
          <div class="fg c1">
            <div><label>Volumen MÂ³</label><input type="text" id="volumen"></div>
          </div>
          <div class="sec"><div class="sn">4</div><div class="sl">Personal</div><div class="sl2"></div></div>
          <div class="fg c2">
            <div><label>Operador</label><input type="text" id="operador"></div>
            <div><label>Precio (manuscrito)</label><input type="number" id="precio" placeholder="1400.07"></div>
          </div>
          <button class="bgen" onclick="addEntry()">âš¡ Guardar registro</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="ts">
    <div class="th2">
      <div class="ttl">Registros <span class="cb" id="rc">0</span></div>
      <div class="tacts">
        <button class="bxl" id="bex" onclick="exportExcel()" disabled>â†“ Excel</button>
        <button class="bclr" onclick="clearAll()">Limpiar</button>
      </div>
    </div>
    <div class="empty" id="em">
      <div class="ei">ðŸ§¾</div>
      <p style="color:var(--mu)">Sin registros aÃºn</p>
      <p style="font-size:11px;color:var(--mu2);max-width:200px;">Carga una foto de la boleta de bÃ¡scula para comenzar.</p>
    </div>
    <div class="tw" id="tw" style="display:none">
      <table>
        <thead>
          <tr>
            <th>#</th><th>FOLIO</th><th>FECHA</th><th>H. ENTRADA</th><th>H. SALIDA</th>
            <th>CLIENTE</th><th>RUTA</th><th>#ECO</th>
            <th>TIPO UNIDAD</th><th>TIPO RESIDUOS</th>
            <th>BRUTO kg</th><th>TARA kg</th><th>NETO kg</th><th>VOL MÂ³</th>
            <th>OPERADOR</th><th>PRECIO</th><th>ACCIONES</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const PROXY_URL='https://suminregio-proxy.onrender.com';
const STOR='pasa_notas_v1';
const API_KEY_STOR='pasa_api_key';
let records=[],files=[],results=[],rIdx=0,scanCount=0;
let confResolve=null;
let API_KEY='';

function showConfirm(msg,okLabel='Eliminar'){
  return new Promise(resolve=>{
    confResolve=(v)=>{document.getElementById('confOv').style.display='none';resolve(v);};
    document.getElementById('confMsg').textContent=msg;
    document.getElementById('confOkBtn').textContent=okLabel;
    document.getElementById('confOv').style.display='flex';
  });
}

// â”€â”€ PROMPT OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROMPT=`Eres un experto en lectura de boletas de bÃ¡scula del relleno sanitario GEN PASA (empresa de reciclaje en MÃ©xico).

Analiza la imagen de esta boleta y extrae los datos con precisiÃ³n. La boleta tiene este layout especÃ­fico:

SECCIÃ“N SUPERIOR (encabezado impreso):
- "FOLIO:" seguido del nÃºmero (formato R##### o similar)
- "CONTADO" puede aparecer como texto
- Logo GEN PASA con hoja verde en esquina superior derecha

SECCIÃ“N IZQUIERDA (campos impresos con valores escritos):
- "Cliente:" â€” IMPORTANTE: el cliente generalmente estÃ¡ escrito a mano debajo del campo impreso
- "Tipo unidad:" â€” tipo de vehÃ­culo (ej: HELO SECO, REMOLQUE, TRAILER, etc.)
- "Tipo residuos:" â€” tipo de residuo (ej: RESIDUOS, BIOSOULTA, RSU, etc.)
- "Procedencia:" â€” origen del residuo (ej: SUMINREGIO, nombre de empresa)
- "Basculista:" â€” nombre del operador de bÃ¡scula
- "Promotora Ambiental de la Laguna S:" o similar â€” nombre de promotora

SECCIÃ“N DERECHA (campos con valores):
- "RUTA" seguido de cÃ³digo alfanumÃ©rico â€” estÃ¡ en la lÃ­nea de "Transportista", lado derecho. El valor incluye letras Y nÃºmeros (ej: "PW0179B"). EstÃ¡ ENCIMA del campo #ECO.
- "# ECO." seguido SOLO de nÃºmeros â€” estÃ¡ DEBAJO de RUTA (ej: "0179"). Solo dÃ­gitos, sin letras.
- "Operador:" â€” nombre del operador (ej: OSCAR SILER)

SECCIÃ“N DE RECUADRO (peso e informaciÃ³n de bÃ¡scula):
- "PRIMERA PESADA" o "SEGUNDA PESADA" como tipo
- Fecha y hora (ej: 25/02/2026 09:02)
- "BRUTO:" â€” peso bruto en kg (ej: 10,440 kg)
- "PESO DE SALIDA:" â€” esto es la TARA (ej: 8,560 kg)
- "NETO:" â€” peso neto calculado (ej: 1,880 kg) â€” a veces escrito con "Â±" al inicio
- "VOL. MÂ³:" â€” volumen en metros cÃºbicos

TEXTO MANUSCRITO (escrito a mano con bolÃ­grafo):
- El nombre del conductor/operador del vehÃ­culo suele estar escrito a mano (ej: "Fud Trailer", "Haller")
- CF: nÃºmero escrito a mano precedido de "CF:"
- Fax y otros datos de contacto pueden estar escritos a mano

Devuelve ÃšNICAMENTE este JSON (sin markdown, sin texto extra):
{
  "folio": "",
  "fecha": "",
  "hora_entrada": "",
  "hora_salida": "",
  "cliente": "",
  "ruta": "",
  "eco": "",
  "tipo_unidad": "",
  "tipo_residuos": "",
  "bruto": "",
  "tara": "",
  "neto": "",
  "volumen": "",
  "operador": "",
  "precio": ""
}

Reglas estrictas de extracciÃ³n:
- folio: solo el nÃºmero/cÃ³digo (ej: "R82742")
- fecha: formato DD/MM/YYYY
- hora_entrada: hora de la PRIMERA PESADA (ej: "09:02")
- hora_salida: hora que aparece junto a "PESO DE SALIDA" (ej: "09:35")
- cliente: el nombre escrito a MANO en la boleta â€” generalmente es el nombre del conductor o empresa escrito con bolÃ­grafo (ej: "Fud Trailer", "Haller") â€” NO usar el texto impreso del campo "Cliente:"
- ruta: valor del campo "RUTA" en la boleta. REGLA CRÃTICA: ruta y eco NUNCA pueden ser el mismo valor. Si estÃ¡s a punto de poner el mismo nÃºmero en ruta y en eco, significa que no encontraste el valor de RUTA â€” en ese caso deja ruta vacÃ­o "".
- eco: valor del campo "# ECO." â€” solo nÃºmeros (ej: "0179").
- tipo_unidad: tipo de vehÃ­culo (ej: "REMOLQUE", "TRAILER", "HELO SECO")
- tipo_residuos: tipo de residuo (ej: "HIELO SECO", "RSU", "RESIDUOS")
- bruto: solo dÃ­gitos del peso bruto en kg, sin comas ni "kg" (ej: "10440")
- tara: el valor de "PESO DE SALIDA" en kg, solo dÃ­gitos (ej: "8560")
- neto: solo dÃ­gitos del peso neto, sin "Â±" ni "kg" (ej: "1880")
- volumen: valor numÃ©rico del volumen MÂ³ (ej: "1.88")
- operador: nombre del operador impreso (ej: "OSCAR STILLER")
- observaciones: cualquier otro dato relevante no capturado
- precio: valor numÃ©rico escrito a mano al final de la boleta, generalmente en la parte inferior izquierda (ej: "1400.07") â€” solo el nÃºmero sin sÃ­mbolo de moneda
- cliente: IGNORAR COMPLETAMENTE el texto impreso del campo "Cliente:" aunque diga "4 CLIENTES PARTICULARES" u otro texto preimpreso. Buscar Ãºnicamente texto escrito a mano con bolÃ­grafo en la boleta â€” generalmente es el nombre del conductor o empresa transportista escrito manualmente (ej: "Fud Trailer", "Haller"). Si no hay texto manuscrito claro, dejar vacÃ­o.
- Si un campo no estÃ¡ visible, dejar como ""
- NO inventes datos â€” solo extrae lo que claramente estÃ¡ escrito`;

// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save(){
  localStorage.setItem(STOR,JSON.stringify(records));
  const sp=document.getElementById('sp');sp.classList.add('show');
  setTimeout(()=>sp.classList.remove('show'),2000);
}
function load(){
  const d=localStorage.getItem(STOR);
  if(d)records=JSON.parse(d);
  render();
}
function checkKey(){
  API_KEY=localStorage.getItem(API_KEY_STOR)||'';
  if(!API_KEY)document.getElementById('akOv').style.display='flex';
  else document.getElementById('akOv').style.display='none';
}
function saveKey(){
  const k=document.getElementById('akInput').value.trim();
  if(!k.startsWith('sk-ant')){document.getElementById('akErr').style.display='block';return;}
  API_KEY=k;localStorage.setItem(API_KEY_STOR,k);
  document.getElementById('akOv').style.display='none';toast('âœ“ API Key guardada','ok');
}

// â”€â”€ SCAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openScan(){
  files=[];
  document.getElementById('bq').innerHTML='';
  document.getElementById('bq').style.display='none';
  document.getElementById('bstart').disabled=true;
  document.getElementById('progWrap').classList.remove('show');
  document.getElementById('progFill').style.width='0%';
  document.getElementById('progPct').textContent='0%';
  document.getElementById('scanOv').style.display='flex';
}
function closeScan(){document.getElementById('scanOv').style.display='none';files=[];}

const dz=document.getElementById('dz');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');addFiles([...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')));});

function onFiles(e){addFiles([...e.target.files]);e.target.value='';}
function triggerFileOnly(){
  const fi=document.getElementById('fbi');
  fi.removeAttribute('capture');fi.click();
  setTimeout(()=>fi.setAttribute('capture','environment'),1000);
}

function compressImage(file,maxPx,quality){
  return new Promise(resolve=>{
    const r=new FileReader();
    r.onload=ev=>{
      const img=new Image();
      img.onload=()=>{
        let w=img.width,h=img.height;
        if(w>maxPx||h>maxPx){if(w>h){h=Math.round(h*maxPx/w);w=maxPx;}else{w=Math.round(w*maxPx/h);h=maxPx;}}
        const c=document.createElement('canvas');c.width=w;c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        const b64full=c.toDataURL('image/jpeg',quality);
        resolve({b64:b64full.split(',')[1],mime:'image/jpeg',url:b64full});
      };
      img.src=ev.target.result;
    };
    r.readAsDataURL(file);
  });
}

async function addFiles(flist){
  for(const f of flist){
    const comp=await compressImage(f,1600,0.82);
    files.push({name:f.name,b64:comp.b64,mime:comp.mime,url:comp.url,status:'pending'});
    renderQ();
  }
}

function renderQ(){
  const q=document.getElementById('bq');
  q.style.display=files.length?'flex':'none';
  document.getElementById('bstart').disabled=!files.length;
  q.innerHTML=files.map((f,i)=>`<div class="bi ${f.status}">
    <img class="bith" src="${f.url}">
    <div class="bii">
      <div class="bin">${f.name}</div>
      <div class="bis ${f.status}">${f.status==='pending'?'En espera':f.status==='processing'?'Analizando...':f.status==='done'?'âœ“ Listo':'âš  '+(f.err||'Error')}</div>
    </div>
    ${f.status==='pending'?`<button class="birm" onclick="files.splice(${i},1);renderQ()">âœ•</button>`:''}
  </div>`).join('');
}

async function runBatch(){
  if(!files.length)return;
  document.getElementById('bstart').disabled=true;
  document.getElementById('progWrap').classList.add('show');
  results=[];
  for(let i=0;i<files.length;i++){
    files[i].status='processing';renderQ();
    const pct=Math.round((i/files.length)*100);
    document.getElementById('progFill').style.width=pct+'%';
    document.getElementById('progPct').textContent=pct+'%';
    let success=false;
    for(let attempt=1;attempt<=3;attempt++){
      try{
        if(attempt>1){
          const wait=attempt*6000;
          document.getElementById('progText').textContent=`Reintentando ${attempt}/3 â€” espera ${wait/1000}s...`;
          await new Promise(r=>setTimeout(r,wait));
        }
        document.getElementById('progText').textContent=`Analizando ${i+1} de ${files.length}${attempt>1?' (intento '+attempt+')':''}...`;
        const model=attempt<3?'claude-haiku-4-5-20251001':'claude-sonnet-4-20250514';
        const resp=await fetch(PROXY_URL+"/api/scan",{
          method:"POST",
          headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01"},
          body:JSON.stringify({model,max_tokens:1500,messages:[{role:"user",content:[
            {type:"image",source:{type:"base64",media_type:files[i].mime,data:files[i].b64}},
            {type:"text",text:PROMPT}
          ]}]})
        });
        const data=await resp.json();
        const isOverloaded=data.error?.type==='overloaded_error'||data.error?.message?.includes('overloaded')||resp.status===529||resp.status===503;
        if(isOverloaded){if(attempt<3)continue;throw new Error('API temporalmente no disponible. Intenta en unos minutos.');}
        if(!resp.ok||data.error)throw new Error(data.error?.message||`HTTP ${resp.status}`);
        const raw=data.content.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
        results.push({data:JSON.parse(raw),url:files[i].url});
        files[i].status='done';success=true;break;
      }catch(e){
        if(attempt===3){
          files[i].status='error';files[i].err=e.message.substring(0,50);
          results.push(null);toast('âš  '+e.message.substring(0,70),'err');
        }
      }
    }
  }
  document.getElementById('progFill').style.width='100%';
  document.getElementById('progPct').textContent='100%';
  await new Promise(r=>setTimeout(r,400));
  document.getElementById('progWrap').classList.remove('show');
  const valid=results.filter(Boolean).length;
  if(valid===0){
    document.getElementById('bstart').disabled=false;
    toast('âš  Sin conexiÃ³n con la API. Espera un momento y reintenta.','err');
    return;
  }
  closeScan();rIdx=0;nextReview();
}

// â”€â”€ REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextReview(){
  while(rIdx<results.length&&!results[rIdx])rIdx++;
  if(rIdx>=results.length){
    document.getElementById('revOv').style.display='none';
    const valid=results.filter(Boolean).length,total=results.length;
    if(valid===0){toast('âš  No se pudo procesar ninguna boleta.','err');return;}
    toast(`âœ“ ${valid} de ${total} boleta${total>1?'s':''} procesada${total>1?'s':''}`,valid<total?'warn':'ok');
    return;
  }
  document.getElementById('rmc').textContent=`Boleta ${rIdx+1} de ${results.length} â€” verifica y corrige si es necesario`;
  document.getElementById('rimg').src=results[rIdx].url;
  const d=results[rIdx].data;
  const fields=['folio','fecha','hora_entrada','hora_salida','cliente','ruta','eco',
    'tipo_unidad','tipo_residuos','bruto','tara','neto','volumen','operador','precio'];
  fields.forEach(f=>{
    const el=document.getElementById('r_'+f);
    if(el){el.value=d[f]||'';el.classList.toggle('sc',!!(d[f]));}
  });
  document.getElementById('revOv').style.display='flex';
}

function saveRev(){
  const rv=id=>document.getElementById(id)?.value.trim()||'';
  const r={
    id:Date.now(),
    folio:rv('r_folio'),fecha:rv('r_fecha'),
    hora_entrada:rv('r_hora_entrada'),hora_salida:rv('r_hora_salida'),
    cliente:rv('r_cliente'),ruta:rv('r_ruta'),eco:rv('r_eco'),
    tipo_unidad:rv('r_tipo_unidad'),tipo_residuos:rv('r_tipo_residuos'),
    bruto:rv('r_bruto'),tara:rv('r_tara'),neto:rv('r_neto'),
    volumen:rv('r_volumen'),operador:rv('r_operador'),
    precio:rv('r_precio')
  };
  records.push(r);scanCount++;save();render();
  toast('âœ“ Registro guardado','ok');
  rIdx++;nextReview();
}
function skipRev(){rIdx++;nextReview();}

// â”€â”€ MANUAL ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addEntry(){
  const g=id=>document.getElementById(id)?.value.trim()||'';
  const r={id:Date.now(),folio:g('folio'),fecha:g('fecha'),
    hora_entrada:g('hora_entrada'),hora_salida:g('hora_salida'),
    cliente:g('cliente'),ruta:g('ruta'),eco:g('eco'),
    tipo_unidad:g('tipo_unidad'),tipo_residuos:g('tipo_residuos'),
    bruto:g('bruto'),tara:g('tara'),neto:g('neto'),volumen:g('volumen'),
    operador:g('operador'),precio:g('precio')};
  records.push(r);save();render();
  toast('âœ“ Registro guardado','ok');
}

function addEntryMobile(){
  const g=id=>document.getElementById(id)?.value.trim()||'';
  const r={id:Date.now(),folio:g('m_folio'),fecha:g('m_fecha'),
    hora_entrada:g('m_hora_entrada'),hora_salida:g('m_hora_salida'),
    cliente:g('m_cliente'),ruta:g('m_ruta'),eco:g('m_eco'),
    tipo_unidad:g('m_tipo_unidad'),tipo_residuos:g('m_tipo_residuos'),
    bruto:g('m_bruto'),tara:g('m_tara'),neto:g('m_neto'),volumen:g('m_volumen'),
    operador:g('m_operador'),precio:g('m_precio')};
  records.push(r);save();render();
  document.getElementById('manualMobOv').style.display='none';
  toast('âœ“ Registro guardado','ok');
}

function toggleForm(){
  document.getElementById('formToggle').classList.toggle('open');
  document.getElementById('formCollapse').classList.toggle('open');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHero(){
  const hc=document.getElementById('heroCount');
  const hs=document.getElementById('heroScans');
  const he=document.getElementById('heroExcel');
  const rc2=document.getElementById('rc2');
  const bex2=document.getElementById('bex2');
  if(hc)hc.textContent=records.length;
  if(hs)hs.textContent=scanCount;
  if(he)he.disabled=!records.length;
  if(rc2)rc2.textContent=records.length;
  if(bex2)bex2.disabled=!records.length;
}

function render(){
  const tb=document.getElementById('tb'),em=document.getElementById('em'),
    tw=document.getElementById('tw'),btn=document.getElementById('bex'),
    rc=document.getElementById('rc');
  if(rc)rc.textContent=records.length;
  updateHero();
  if(!records.length){em.style.display='flex';tw.style.display='none';btn.disabled=true;return;}
  em.style.display='none';tw.style.display='block';btn.disabled=false;
  tb.innerHTML=records.map((r,i)=>`<tr ${i>=records.length-1?'class="nr"':''}>
    <td class="num">${i+1}</td>
    <td><span class="chip">${r.folio||'â€”'}</span></td>
    <td style="font-family:var(--fc)">${r.fecha||'â€”'}</td>
    <td style="font-family:var(--fc)">${r.hora_entrada||'â€”'}</td>
    <td style="font-family:var(--fc)">${r.hora_salida||'â€”'}</td>
    <td class="wc"><strong>${r.cliente||'â€”'}</strong></td>
    <td style="font-family:var(--fc)">${r.ruta||'â€”'}</td>
    <td style="font-family:var(--fc)">${r.eco||'â€”'}</td>
    <td>${r.tipo_unidad||'â€”'}</td>
    <td class="wc">${r.tipo_residuos||'â€”'}</td>
    <td class="kg">${r.bruto?Number(r.bruto).toLocaleString('es-MX'):'-'}</td>
    <td class="kg" style="color:var(--mu)">${r.tara?Number(r.tara).toLocaleString('es-MX'):'-'}</td>
    <td class="kg">${r.neto?Number(r.neto).toLocaleString('es-MX'):'-'}</td>
    <td style="font-family:var(--fc)">${r.volumen||'â€”'}</td>
    <td>${r.operador||'â€”'}</td>
    <td class="kg">${r.precio?'$'+Number(r.precio).toLocaleString('es-MX',{minimumFractionDigits:2}):'-'}</td>
    <td><div class="ra"><button class="bdl" onclick="delRow(${r.id})">âœ•</button></div></td>
  </tr>`).join('');
}

// â”€â”€ EXCEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildWorkbook(){
  // â”€â”€ HOJA 1: BASE DE DATOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const headers=['FOLIO','FECHA','HORA ENTRADA','HORA SALIDA','CLIENTE','RUTA','#ECO',
    'TIPO UNIDAD','TIPO RESIDUOS',
    'BRUTO KG','TARA KG','NETO KG','NETO TON','VOLUMEN M3',
    'OPERADOR','PRECIO'];
  const rows=records.map(r=>{
    const neto=Number(r.neto)||0;
    return [r.folio,r.fecha,r.hora_entrada,r.hora_salida,
      r.cliente,r.ruta,r.eco,r.tipo_unidad,r.tipo_residuos,
      Number(r.bruto)||'',Number(r.tara)||'',neto||'',
      neto?+(neto/1000).toFixed(3):'',
      r.volumen,r.operador,Number(r.precio)||'',r.observaciones];
  });
  const ws=XLSX.utils.aoa_to_sheet([headers,...rows]);
  ws['!cols']=[10,12,10,10,22,10,8,14,16,10,10,10,9,9,16,10].map(w=>({wch:w}));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Datos');

  // â”€â”€ HOJA 2: ANÃLISIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const wa=XLSX.utils.aoa_to_sheet([[]]);
  wa['!cols']=[28,14,14,14,14,14].map(w=>({wch:w}));
  let row=1;

  const fecha=new Date().toLocaleDateString('es-MX',{day:'2-digit',month:'long',year:'numeric'});
  const totalViajes=records.length;
  const totalNetoKg=records.reduce((s,r)=>s+(Number(r.neto)||0),0);
  const totalNetoTon=+(totalNetoKg/1000).toFixed(3);
  const totalBrutoKg=records.reduce((s,r)=>s+(Number(r.bruto)||0),0);
  const totalPrecio=records.reduce((s,r)=>s+(Number(r.precio)||0),0);
  const totalVolumen=records.reduce((s,r)=>s+(Number(r.volumen)||0),0);

  // Helper para escribir celda con estilo
  function sc(r,c,v,s={}){
    const addr=XLSX.utils.encode_cell({r,c});
    wa[addr]={v,t:typeof v==='number'?'n':'s',...(s.z?{z:s.z}:{})};
    return addr;
  }

  // TÃ­tulo principal
  sc(row-1,0,'ANÃLISIS DE NOTAS DE BÃSCULA â€” GEN PASA');
  sc(row,0,`Generado: ${fecha}`);
  row+=2;

  // â”€ Resumen general â”€
  sc(row-1,0,'RESUMEN GENERAL');
  row++;
  const resumen=[
    ['Total de viajes',totalViajes,'viajes'],
    ['Total neto',totalNetoKg,'kg'],
    ['Total neto',totalNetoTon,'toneladas'],
    ['Total bruto',+(totalBrutoKg/1000).toFixed(3),'toneladas'],
    ['Volumen total',+totalVolumen.toFixed(2),'MÂ³'],
    ['Ingreso total',totalPrecio,'$'],
    ['Promedio neto por viaje',totalViajes?+(totalNetoTon/totalViajes).toFixed(3):0,'ton/viaje'],
    ['Promedio precio por viaje',totalViajes?+(totalPrecio/totalViajes).toFixed(2):0,'$/viaje'],
  ];
  resumen.forEach(([label,val,unit])=>{
    sc(row-1,0,label);
    sc(row-1,1,val);
    sc(row-1,2,unit);
    row++;
  });
  row++;

  // â”€ Por cliente â”€
  const byCliente={};
  records.forEach(r=>{
    const k=(r.cliente||'SIN NOMBRE').toUpperCase().trim();
    if(!byCliente[k])byCliente[k]={viajes:0,netoKg:0,precio:0,volumen:0};
    byCliente[k].viajes++;
    byCliente[k].netoKg+=Number(r.neto)||0;
    byCliente[k].precio+=Number(r.precio)||0;
    byCliente[k].volumen+=Number(r.volumen)||0;
  });
  const clientesSorted=Object.entries(byCliente).sort((a,b)=>b[1].netoKg-a[1].netoKg);

  sc(row-1,0,'POR CLIENTE');
  row++;
  sc(row-1,0,'CLIENTE');sc(row-1,1,'VIAJES');sc(row-1,2,'NETO KG');
  sc(row-1,3,'NETO TON');sc(row-1,4,'PRECIO $');sc(row-1,5,'VOL MÂ³');
  row++;
  clientesSorted.forEach(([k,v])=>{
    sc(row-1,0,k);
    sc(row-1,1,v.viajes);
    sc(row-1,2,v.netoKg);
    sc(row-1,3,+(v.netoKg/1000).toFixed(3));
    sc(row-1,4,+v.precio.toFixed(2));
    sc(row-1,5,+v.volumen.toFixed(2));
    row++;
  });
  // Totales fila
  sc(row-1,0,'TOTAL');
  sc(row-1,1,totalViajes);
  sc(row-1,2,totalNetoKg);
  sc(row-1,3,totalNetoTon);
  sc(row-1,4,+totalPrecio.toFixed(2));
  sc(row-1,5,+totalVolumen.toFixed(2));
  row+=2;

  // â”€ Por operador â”€
  const byOp={};
  records.forEach(r=>{
    const k=(r.operador||'SIN ASIGNAR').toUpperCase().trim();
    if(!byOp[k])byOp[k]={viajes:0,netoKg:0,precio:0};
    byOp[k].viajes++;
    byOp[k].netoKg+=Number(r.neto)||0;
    byOp[k].precio+=Number(r.precio)||0;
  });
  const opSorted=Object.entries(byOp).sort((a,b)=>b[1].viajes-a[1].viajes);

  sc(row-1,0,'POR OPERADOR');
  row++;
  sc(row-1,0,'OPERADOR');sc(row-1,1,'VIAJES');sc(row-1,2,'NETO KG');
  sc(row-1,3,'NETO TON');sc(row-1,4,'PRECIO $');
  row++;
  opSorted.forEach(([k,v])=>{
    sc(row-1,0,k);
    sc(row-1,1,v.viajes);
    sc(row-1,2,v.netoKg);
    sc(row-1,3,+(v.netoKg/1000).toFixed(3));
    sc(row-1,4,+v.precio.toFixed(2));
    row++;
  });
  row+=2;

  // â”€ Por tipo de residuo â”€
  const byResiduo={};
  records.forEach(r=>{
    const k=(r.tipo_residuos||'SIN TIPO').toUpperCase().trim();
    if(!byResiduo[k])byResiduo[k]={viajes:0,netoKg:0};
    byResiduo[k].viajes++;
    byResiduo[k].netoKg+=Number(r.neto)||0;
  });
  const residuoSorted=Object.entries(byResiduo).sort((a,b)=>b[1].netoKg-a[1].netoKg);

  sc(row-1,0,'POR TIPO DE RESIDUO');
  row++;
  sc(row-1,0,'TIPO RESIDUO');sc(row-1,1,'VIAJES');sc(row-1,2,'NETO KG');sc(row-1,3,'NETO TON');sc(row-1,4,'% DEL TOTAL');
  row++;
  residuoSorted.forEach(([k,v])=>{
    sc(row-1,0,k);
    sc(row-1,1,v.viajes);
    sc(row-1,2,v.netoKg);
    sc(row-1,3,+(v.netoKg/1000).toFixed(3));
    sc(row-1,4,totalNetoKg?+(v.netoKg/totalNetoKg*100).toFixed(1):0);
    row++;
  });
  row+=2;

  // â”€ Por tipo de unidad â”€
  const byUnidad={};
  records.forEach(r=>{
    const k=(r.tipo_unidad||'SIN TIPO').toUpperCase().trim();
    if(!byUnidad[k])byUnidad[k]={viajes:0,netoKg:0};
    byUnidad[k].viajes++;
    byUnidad[k].netoKg+=Number(r.neto)||0;
  });
  const unidadSorted=Object.entries(byUnidad).sort((a,b)=>b[1].viajes-a[1].viajes);

  sc(row-1,0,'POR TIPO DE UNIDAD');
  row++;
  sc(row-1,0,'TIPO UNIDAD');sc(row-1,1,'VIAJES');sc(row-1,2,'NETO KG');sc(row-1,3,'NETO TON');
  row++;
  unidadSorted.forEach(([k,v])=>{
    sc(row-1,0,k);
    sc(row-1,1,v.viajes);
    sc(row-1,2,v.netoKg);
    sc(row-1,3,+(v.netoKg/1000).toFixed(3));
    row++;
  });
  row+=2;

  // â”€ Por fecha â”€
  const byFecha={};
  records.forEach(r=>{
    const k=r.fecha||'SIN FECHA';
    if(!byFecha[k])byFecha[k]={viajes:0,netoKg:0,precio:0};
    byFecha[k].viajes++;
    byFecha[k].netoKg+=Number(r.neto)||0;
    byFecha[k].precio+=Number(r.precio)||0;
  });
  const fechaSorted=Object.entries(byFecha).sort((a,b)=>a[0].localeCompare(b[0]));

  sc(row-1,0,'POR FECHA');
  row++;
  sc(row-1,0,'FECHA');sc(row-1,1,'VIAJES');sc(row-1,2,'NETO KG');sc(row-1,3,'NETO TON');sc(row-1,4,'PRECIO $');
  row++;
  fechaSorted.forEach(([k,v])=>{
    sc(row-1,0,k);
    sc(row-1,1,v.viajes);
    sc(row-1,2,v.netoKg);
    sc(row-1,3,+(v.netoKg/1000).toFixed(3));
    sc(row-1,4,+v.precio.toFixed(2));
    row++;
  });

  wa['!ref']=XLSX.utils.encode_range({s:{r:0,c:0},e:{r:row+2,c:5}});
  XLSX.utils.book_append_sheet(wb,wa,'AnÃ¡lisis');

  return wb;
}

function exportExcel(){
  if(!records.length)return;
  const wb=buildWorkbook();
  const filename=`PASA_NotasBascula_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb,filename);
  toast('âœ“ Excel descargado','ok');
}

async function shareExcel(){
  if(!records.length)return;
  const wb=buildWorkbook();
  const filename=`PASA_NotasBascula_${new Date().toISOString().slice(0,10)}.xlsx`;
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  const blob=new Blob([wbout],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const file=new File([blob],filename,{type:blob.type});
  if(navigator.canShare&&navigator.canShare({files:[file]})){
    try{
      await navigator.share({files:[file],title:'Notas BÃ¡scula PASA',
        text:`GEN PASA â€” ${records.length} registro${records.length>1?'s':''} Â· ${new Date().toLocaleDateString('es-MX')}`});
      toast('âœ“ Archivo compartido','ok');
    }catch(e){if(e.name!=='AbortError')toast('Error al compartir','err');}
  }else{
    XLSX.writeFile(wb,filename);toast('âœ“ Excel descargado','ok');
  }
}

async function delRow(id){
  if(!await showConfirm('Â¿Eliminar este registro?'))return;
  records=records.filter(r=>r.id!==id);save();render();
}
async function clearAll(){
  if(!await showConfirm('Â¿Eliminar todos los registros?','Eliminar todo'))return;
  records=[];localStorage.removeItem(STOR);render();
}
function toast(msg,type='ok'){
  const t=document.getElementById('toast');t.textContent=msg;
  t.className=`toast ${type} show`;setTimeout(()=>t.classList.remove('show'),3500);
}

checkKey();load();
</script>
</body>
</html>
